---
title: "STA 442 Hw2Q2"
output:
  word_document: default
  html_document:
    df_print: paged
  html_notebook: default
---


2.

```{r}
dataDir = "../data"
smokeFile = file.path(dataDir, "smoke2014.RData") 
if (!file.exists(smokeFile)) {
download.file("http://pbrown.ca/teaching/appliedstats/data/smoke2014.RData", smokeFile)
}
load(smokeFile)

smoke[1:3,c('Age','ever_cigarettes','Sex','Race', 
        'state','school', 'RuralUrban')]
forInla = smoke[smoke$Age > 10, c("Age", "ever_cigarettes", "Sex", "Race", "state", "school", "RuralUrban", "Harm_belief_of_chewing_to")]
forInla = na.omit(forInla)
forInla$y = as.numeric(forInla$ever_cigarettes)
forInla$ageFac = factor(as.numeric(as.character(forInla$Age))) 
forInla$chewingHarm = factor(forInla$Harm_belief_of_chewing_to,levels = 1:4, labels = c("less", "equal", "more", "dunno"))
library("INLA")
toPredict = expand.grid(ageFac = levels(forInla$ageFac),
RuralUrban = levels(forInla$RuralUrban), chewingHarm = levels(forInla$chewingHarm),
Sex = levels(forInla$Sex))
forLincombs = do.call(inla.make.lincombs, as.data.frame(model.matrix(~Sex +ageFac * RuralUrban * chewingHarm, data = toPredict))) 
fitS2 = inla(y ~ Sex + ageFac * RuralUrban * chewingHarm +f(state, model = "iid", hyper = list(prec = list(prior = "pc.prec", param = c(99, 0.05)))), data = forInla, family = "binomial",control.inla = list(strategy = "gaussian"), lincomb = forLincombs) 
theCoef = exp(fitS2$summary.lincomb.derived[, c("0.5quant", "0.025quant", "0.975quant")])
theCoef = theCoef/(1 + theCoef)
toPredict$Age = as.numeric(as.character(toPredict$ageFac))
toPredict$shiftX = as.numeric(toPredict$chewingHarm)/10
toPredict$x = toPredict$Age + toPredict$shiftX
toPlot = toPredict$Sex == "M" & toPredict$RuralUrban == "Rural"
plot(toPredict[toPlot, "x"], theCoef[toPlot, "0.5quant"], xlab = "age", ylab = "probability", ylim = c(0,1), pch = 15, col = toPredict[toPlot, "chewingHarm"]) 
segments(toPredict[toPlot, "x"], theCoef[toPlot, "0.025quant"],y1 = theCoef[toPlot, "0.975quant"], col = toPredict[toPlot, "chewingHarm"])
legend("topleft", fill = 1:nlevels(toPredict$chewingHarm), legend = levels(toPredict$chewingHarm), bty = "n", title = "chewing harmful")

```
Introduction

We want to investigate these hytpotheses are true such that geographic variation (between states) in the rate of smoking among students is substantially greater than variation amongst schools, and the rural-urban difference are greater than differences between states. Moreover, we will figure out the effect of age on smoking for different races.


Method

```{r}


fitS1 = inla(y ~Sex + ageFac * RuralUrban * chewingHarm+ f(school, model = "iid", hyper = list(prec = list(prior = "pc.prec",param = c(99, 0.5)))) +f(state, model = "iid",hyper = list(prec = list(prior = "pc.prec", param = c(99, 0.5)))), data = forInla, family = "binomial",control.inla = list(strategy = "gaussian"), lincomb = forLincombs,verbose = TRUE)
knitr::kable(rbind(fitS2$summary.fixed[, c("mean", "0.025quant", "0.975quant")]), digits=3, 
  caption = "Summary of coefficients in the model",)
```

```{r}
fitS1$priorPost<-Pmisc::priorPostSd(fitS1)
fitS1$priorPost$summary
xseq = seq(-100, 100, len=10000)
plot(fitS1$marginals.fixed$'(Intercept)', type='l',col="blue")
lines(xseq, dnorm(xseq, mean=fitS1$priorPost$summary$mean, sd=fitS1$priorPost$summary$sd),lwd=0.2)
```










```{r}
forInla = smoke[,c('Age','ever_cigarettes','Sex','Race', 
        'state','school', 'RuralUrban')]
forInla = na.omit(forInla)
forInla$y = as.numeric(forInla$ever_cigarettes)
forInla$ageFac = relevel(factor(forInla$Age), '14')

  toPredict = expand.grid(
    ageFac = levels(forInla$ageFac),
    RuralUrban = levels(forInla$RuralUrban),
    Sex = levels(forInla$Sex)
    )
forLincombs = do.call(inla.make.lincombs, 
  as.data.frame(model.matrix( ~ ageFac:RuralUrban + Sex, 
    data=toPredict)))
fitS2 = inla(y ~ Sex + ageFac:RuralUrban + 
    f(state, model='iid', hyper=list(
        prec=list(prior='pc.prec', param=c(log(1.1), 0.5)))
    ),
  data=forInla, family='binomial',
  lincomb = forLincombs,
  control.inla = list(strategy='laplace', fast=FALSE))

fitS2$summary.hyperpar
theSd= Pmisc::priorPost(fitS2)





toPredict$Age = as.numeric(as.character(toPredict$ageFac))

isMale = toPredict$Sex == 'M'
shiftRural = 0.1*(toPredict$RuralUrban == 'Rural')

theSd = fitS4$summary.lincomb.derived[,'sd']
theCex = min(theSd)/theSd

plot(toPredict[isMale,'Age'] + shiftRural[isMale], 
  theCoef[isMale,'0.5quant'], 
  xlab='age', ylab='probability', ylim = c(0.015, 1),
  pch = 15, log='y', 
  cex = 2*theCex,
  col = mapmisc::col2html(
    c(Urban = 'red', Rural = 'green')[as.character(toPredict[isMale,'RuralUrban'])],
    0.4)
  ,cap = "effect of Age")


segments(toPredict[isMale,'Age']+ shiftRural[isMale], 
  theCoef[isMale,'0.025quant'], 
  y1=theCoef[isMale,'0.975quant'],
  col = c(Urban = 'red', Rural = 'green')[as.character(toPredict[isMale,'RuralUrban'])])

legend('bottomright', pch=16, col=c('red','green'), legend = c('Urban','Rural'),
  bty='n')


 do.call(matplot, theSd4$sd$matplot)
 do.call(legend, theSd4$sd$legend)
 mtext(expression(sigma), side=1)

```




Conclusion

From standard deviation comparison between random effects of state and school the effect of school influences on more about the rate of smoking so that we need to specify the school where students with higher rate of smoking and supply the tobacco control program on that school. The effect of age is stronger than the ruralUrban effect.





